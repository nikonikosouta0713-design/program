/**
 * ğŸŒ Earthquake Realtime Map (P2På¯¾å¿œãƒ»1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµ)
 * ---------------------------------------
 * 1. Node.jsã ã‘ã§èµ·å‹•ã§ãã¾ã™ï¼ˆnpm install express wsï¼‰
 * 2. HTML + WebSocketã‚µãƒ¼ãƒãƒ¼ã‚’åŒæ™‚ã«æä¾›
 * 3. è¤‡æ•°ãƒ–ãƒ©ã‚¦ã‚¶é–“ã§ã‚¯ãƒªãƒƒã‚¯ã—ãŸéœ‡æºã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰
 * ---------------------------------------
 * èµ·å‹•æ–¹æ³•ï¼š
 *   npm install express ws
 *   node earthquake_p2p_server.js
 * ---------------------------------------
 * è¡¨ç¤ºURLï¼š
 *   http://localhost:3000
 */

import express from "express";
import { WebSocketServer } from "ws";
import http from "http";

// ------------------------
// åŸºæœ¬è¨­å®š
// ------------------------
const app = express();
const server = http.createServer(app);
const wss = new WebSocketServer({ server });
const PORT = process.env.PORT || 3000;

// ------------------------
// HTMLã‚’è¿”ã™
// ------------------------
app.get("/", (_, res) => {
  res.send(`<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ°éœ‡ãƒãƒƒãƒ— P2Pãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰ç‰ˆ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    body,html{margin:0;padding:0;height:100%;width:100%;}
    #map{height:100vh;width:100vw;}
    .leaflet-popup-content{font-size:14px;}
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ====== åœ°å›³ã®åˆæœŸåŒ– ======
    const map = L.map('map').setView([36.5,138],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'Â© OpenStreetMap'
    }).addTo(map);

    // ====== WebSocketæ¥ç¶š ======
    const ws = new WebSocket(location.origin.replace(/^http/,'ws'));

    ws.onopen = () => console.log("ğŸ”— WebSocketæ¥ç¶šæˆåŠŸ");
    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if(data.type==="quake"){
        const {lat, lon, depth, mag, color} = data;
        L.circle([lat, lon], {
          color: color || "red",
          radius: 10000,
          fillOpacity: 0.5
        }).addTo(map)
         .bindPopup(\`éœ‡æºåœ°ï¼š(\${lat.toFixed(2)}, \${lon.toFixed(2)})<br>æ·±ã•ï¼š\${depth}km<br>M\${mag}\`);
      }
    };

    // ====== ã‚¯ãƒªãƒƒã‚¯ã§éœ‡æºé€ä¿¡ ======
    map.on("click", (e) => {
      const quake = {
        type:"quake",
        lat:e.latlng.lat,
        lon:e.latlng.lng,
        depth:(Math.random()*300).toFixed(1),
        mag:(Math.random()*7).toFixed(1),
        color:"orange"
      };
      ws.send(JSON.stringify(quake));
      // è‡ªåˆ†ã®ç”»é¢ã«ã‚‚è¡¨ç¤º
      L.circle([quake.lat, quake.lon], {
        color: quake.color,
        radius: 10000,
        fillOpacity:0.5
      }).addTo(map)
       .bindPopup(\`éœ‡æºåœ°ï¼š(\${quake.lat.toFixed(2)}, \${quake.lon.toFixed(2)})<br>æ·±ã•ï¼š\${quake.depth}km<br>M\${quake.mag}\`);
    });
  </script>
</body>
</html>`);
});

// ------------------------
// WebSocketé€šä¿¡å‡¦ç†
// ------------------------
wss.on("connection", (ws) => {
  console.log("ğŸ›°ï¸ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶š");
  ws.on("message", (msg) => {
    // å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸è»¢é€ï¼ˆP2På…±æœ‰ï¼‰
    wss.clients.forEach((client) => {
      if (client !== ws && client.readyState === 1) {
        client.send(msg.toString());
      }
    });
  });
  ws.on("close", () => console.log("âŒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ‡æ–­"));
});

// ------------------------
// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
// ------------------------
server.listen(PORT, () => console.log("ğŸŒ åœ°éœ‡ãƒãƒƒãƒ—ã‚µãƒ¼ãƒãƒ¼ç¨¼åƒä¸­ â†’ http://localhost:" + PORT));
